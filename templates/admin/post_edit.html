{% extends "admin/base.html" %}

{% block title %}{{ 'Edit Post' if post else 'New Post' }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    #editor { min-height: 400px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ 'Edit Post' if post else 'New Post' }}</h1>
    <a href="{{ url_for('admin.posts_list') }}" class="btn btn-secondary">Back to Posts</a>
</div>

<form method="POST" enctype="multipart/form-data" id="post-form">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               value="{{ post.title if post else '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="slug">Slug * <small class="text-muted">(URL-friendly, e.g., "my-blog-post")</small></label>
                        <input type="text" class="form-control" id="slug" name="slug" 
                               value="{{ post.slug if post else '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="excerpt">Excerpt</label>
                        <textarea class="form-control" id="excerpt" name="excerpt" rows="2">{{ post.excerpt if post else '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editor">Content *</label>
                        <div id="editor">{{ post.html_content|safe if post else '' }}</div>
                        <input type="hidden" name="html_content" id="html_content">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">Publish</div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-control" id="status" name="status">
                            <option value="draft" {{ 'selected' if post and post.status == 'draft' else '' }}>Draft</option>
                            <option value="published" {{ 'selected' if post and post.status == 'published' else '' }}>Published</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="month_key">Month * <small class="text-muted">(YYYY-MM)</small></label>
                        <input type="text" class="form-control" id="month_key" name="month_key" 
                               placeholder="2026-01" value="{{ post.month_key if post else '' }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="published_date">Publish Date</label>
                        <input type="date" class="form-control" id="published_date" name="published_date" 
                               value="{{ post.published_at.strftime('%Y-%m-%d') if post and post.published_at else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="published_time">Publish Time</label>
                        <input type="time" class="form-control" id="published_time" name="published_time" 
                               value="{{ post.published_at.strftime('%H:%M') if post and post.published_at else '12:00' }}">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-save"></i> {{ 'Update' if post else 'Create' }} Post
                    </button>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">Post Details</div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="category">Category</label>
                        <input type="text" class="form-control" id="category" name="category" 
                               placeholder="e.g., A Video I Watched" value="{{ post.category if post else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="read_time">Read Time (minutes)</label>
                        <input type="number" class="form-control" id="read_time" name="read_time" 
                               value="{{ post.read_time if post else 5 }}" min="1">
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">Hero Image</div>
                <div class="card-body">
                    {% if post and post.hero_image_path %}
                    <img src="{{ post.hero_image_path }}" class="img-fluid mb-2" alt="Current hero image">
                    {% endif %}
                    <div class="form-group">
                        <label for="hero_image">Upload New Image</label>
                        <input type="file" class="form-control-file" id="hero_image" name="hero_image" accept="image/*">
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
// Initialize Quill editor
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            ['link', 'image'],
            ['clean']
        ]
    }
});

// Auto-generate slug from title
$('#title').on('blur', function() {
    if (!$('#slug').val()) {
        let slug = $(this).val()
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        $('#slug').val(slug);
    }
});

// Image upload handler for Quill
quill.getModule('toolbar').addHandler('image', function() {
    let input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();
    
    input.onchange = function() {
        let file = input.files[0];
        let formData = new FormData();
        formData.append('image', file);
        
        $.ajax({
            url: '{{ url_for("admin.upload_image") }}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                let range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', data.url);
            },
            error: function() {
                alert('Image upload failed');
            }
        });
    };
});

// Form submission
$('#post-form').submit(function() {
    $('#html_content').val(quill.root.innerHTML);
});
</script>
{% endblock %}

