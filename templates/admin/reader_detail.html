{% extends "admin/base.html" %}

{% block content %}
<style>
    .stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2563eb;
    }
    .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        text-transform: uppercase;
    }
    .post-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        margin-bottom: 20px;
        transition: all 0.2s;
    }
    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
    <div>
        <h1 class="h2 mb-1"><i class="fas fa-user"></i> {{ reader_label }}</h1>
        <p class="text-muted mb-0">
            {% if reader_type == 'user' %}
            <span class="badge bg-success">Logged In User</span>
            {% else %}
            <span class="badge bg-secondary">Anonymous Reader</span>
            {% endif %}
        </p>
    </div>
    <a href="{{ url_for('admin.readers_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Readers
    </a>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-label">Posts Read</div>
            <div class="stat-number">{{ posts_read|length }}</div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-label">Total Read Events</div>
            <div class="stat-number">{{ total_events }}</div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-3">
        <div class="stat-card">
            <div class="stat-label">Avg Events per Post</div>
            <div class="stat-number">{{ (total_events / posts_read|length)|round(1) if posts_read|length > 0 else 0 }}</div>
        </div>
    </div>
</div>

<!-- Posts Read -->
<div class="row">
    <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-book"></i> Posts Read</h4>
        
        {% if posts_read %}
        {% for post_id, data in posts_read.items() %}
        <div class="post-card">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-2">
                        <a href="{{ url_for('post_detail', slug=data.post.slug) }}" target="_blank" style="color: #1a1a1a;">
                            {{ data.post.title }}
                        </a>
                    </h5>
                    <p class="text-muted mb-0">
                        <small>
                            <i class="fas fa-calendar"></i> {{ data.post.published_at.strftime('%b %d, %Y') if data.post.published_at }}
                        </small>
                    </p>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">
                            {{ data.max_percent }}%
                        </div>
                        <small class="text-muted">Max Progress</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">
                            {{ (data.total_time / 60)|round(1) }}
                        </div>
                        <small class="text-muted">Total Time (min)</small>
                    </div>
                </div>
            </div>
            
            <!-- Event Details -->
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#events-{{ post_id }}">
                    <i class="fas fa-list"></i> Show {{ data.events|length }} Events
                </button>
                
                <div class="collapse mt-2" id="events-{{ post_id }}">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Progress</th>
                                <th>Time</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in data.events %}
                            <tr>
                                <td style="font-size: 11px;">{{ event.created_at.strftime('%b %d, %H:%M:%S') }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <div style="flex: 1; background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden; min-width: 60px;">
                                            <div style="width: {{ event.percent }}%; background: #2563eb; height: 100%;"></div>
                                        </div>
                                        <span style="font-size: 10px;">{{ event.percent }}%</span>
                                    </div>
                                </td>
                                <td style="font-size: 11px;">{{ (event.seconds / 60)|round(1) }} min</td>
                                <td><code style="font-size: 10px;">{{ event.ip_address }}</code></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center text-muted p-5">
            <i class="fas fa-book-open" style="font-size: 3rem; opacity: 0.3;"></i>
            <p class="mt-3">No posts read yet</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

